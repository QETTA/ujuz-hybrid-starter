name: Auto-approve and merge PRs

on:
  pull_request_target:
    types: [opened, reopened, labeled, synchronize]
  workflow_dispatch: {}

jobs:
  auto-approve-and-merge:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      actions: write

    steps:
      - name: Check PR labels/author
        uses: actions/github-script@v6
        id: check
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            // proceed only if label `auto-merge` or `bypass` is present (prevents accidental merges)
            return { canProceed: labels.includes('auto-merge') || labels.includes('bypass') };

      - name: Stop if not labeled
        if: "steps.check.outputs.canProceed != 'true'"
        run: echo "No auto-merge/bypass label; skipping approval and merge." && exit 0

      - name: Auto-approve PR
        uses: hmarr/auto-approve-action@v2.0.0
        with:
          github-token: ${{ secrets.BOT_PAT }}
          # NOTE: 'BOT_PAT' must be created by a repo admin and must have 'repo' scope.

      - name: Merge PR (squash)
        uses: peter-evans/merge-pull-request@v3
        with:
          token: ${{ secrets.BOT_PAT }}
          merge-method: squash
          commit-message: title

      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: 'Auto-approved and merged by workflow (label: `auto-merge` or `bypass`). Merge method: squash.'
            });
