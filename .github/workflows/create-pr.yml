name: Create PR for automation branch

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to create PR from'
        required: true
        default: 'chore/dev/copilot-vscode-setup-windows'

jobs:
  create_pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Create or find PR
        uses: actions/github-script@v6
        with:
          script: |
            const branch = core.getInput('branch') || 'chore/dev/copilot-vscode-setup-windows';
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Check existing PRs
            const { data: prs } = await github.rest.pulls.list({ owner, repo, head: `${owner}:${branch}` });
            if (prs.length > 0) {
              const pr = prs[0];
              core.setOutput('prUrl', pr.html_url);
              return;
            }

            // Create PR
            const { data: repoInfo } = await github.rest.repos.get({ owner, repo });
            const base = repoInfo.default_branch || 'master';
            const title = 'chore: add Copilot prompts + VS Code setup + auto-approve workflow';
            const body = `This PR adds Copilot prompts, VSCode settings, a label-driven auto-approve workflow, and admin instructions. If you want automation enabled, please add repo secret BOT_PAT (see docs/admin/enable-bypass.md).`;

            const pr = await github.rest.pulls.create({ owner, repo, title, head: branch, base, body });

            // Add bypass label to trigger downstream auto-approve workflow
            await github.rest.issues.addLabels({ owner, repo, issue_number: pr.data.number, labels: ['bypass'] });

            core.setOutput('prUrl', pr.data.html_url);

      - name: Output PR URL
        run: echo "PR created or found: ${{ steps.create_pr.outputs.prUrl }}"