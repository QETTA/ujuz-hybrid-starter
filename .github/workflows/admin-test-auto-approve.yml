name: Admin: Test Auto-approve Flow

on:
  workflow_dispatch: {}

jobs:
  create-test-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Check for BOT_PAT secret
        id: check
        run: |
          if [ -z "${{ secrets.BOT_PAT }}" ]; then
            echo "BOT_PAT_PRESENT=false" >> $GITHUB_OUTPUT
            echo "Warning: BOT_PAT secret is not set. The auto-approve step will not be able to approve/merge." >&2
            exit 0
          else
            echo "BOT_PAT_PRESENT=true" >> $GITHUB_OUTPUT
          fi

      - name: Create test branch and file + open PR
        uses: actions/github-script@v6
        id: create_pr
        with:
          script: |
            const ts = Date.now();
            const branch = `test/auto-approve-${ts}`;
            const contentPath = `.github/tmp/test-auto-approve-${ts}.md`;
            const content = `Test file created at ${new Date(ts).toISOString()} to verify auto-approve flow.`;

            // Get default branch
            const { data: repo } = await github.rest.repos.get({ owner: context.repo.owner, repo: context.repo.repo });
            const base = repo.default_branch || 'master';

            // Create branch from default branch
            const baseRef = (await github.rest.git.getRef({ owner: context.repo.owner, repo: context.repo.repo, ref: `heads/${base}` })).data.object.sha;
            await github.rest.git.createRef({ owner: context.repo.owner, repo: context.repo.repo, ref: `refs/heads/${branch}`, sha: baseRef });

            // Create a file on the new branch
            await github.rest.repos.createOrUpdateFileContents({ owner: context.repo.owner, repo: context.repo.repo, path: contentPath, message: `chore(ci): add test file for auto-approve ${ts}`, content: Buffer.from(content).toString('base64'), branch });

            // Create PR
            const pr = await github.rest.pulls.create({ owner: context.repo.owner, repo: context.repo.repo, title: `ci(test): auto-approve test ${ts}`, head: branch, base, body: 'This PR is created by the admin-test workflow to validate the auto-approve/bypass workflow.' });

            // Add label 'bypass' to trigger the auto-approve workflow
            await github.rest.issues.addLabels({ owner: context.repo.owner, repo: context.repo.repo, issue_number: pr.data.number, labels: ['bypass'] });

            return { prNumber: pr.data.number, prUrl: pr.data.html_url, branch };

      - name: Output result
        if: steps.create_pr.outputs.prUrl != ''
        run: |
          echo "Created PR: ${{ steps.create_pr.outputs.prUrl }}"