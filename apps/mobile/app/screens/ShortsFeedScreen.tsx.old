/**
 * ShortsFeedScreen - TikTok/Reels Style Vertical Video Feed
 *
 * KidsMap 독자 기능: 장소 미리보기 숏폼 영상
 * Features:
 * - Vertical swipe navigation
 * - Full-screen video playback
 * - Related place link
 * - Like, comment, share, save actions
 */

import React, { useState, useRef, useCallback } from 'react';
import {
  View,
  Text,
  FlatList,
  TouchableOpacity,
  TouchableWithoutFeedback,
  StyleSheet,
  Dimensions,
  SafeAreaView,
  ViewToken,
  Animated,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import * as Haptics from 'expo-haptics';
import { useNavigation } from '@react-navigation/native';
import { VideoPlayer } from '@/app/components/feed';
import type { PlaceWithDistance } from '@/app/types/places';
import type { ShortsScreenNavigationProp } from '@/app/types/navigation';

const { height: SCREEN_HEIGHT, width: SCREEN_WIDTH } = Dimensions.get('window');

// Mock shorts data
interface ShortsVideo {
  id: string;
  youtubeId: string;
  title: string;
  author: string;
  authorAvatar?: string;
  likes: number;
  comments: number;
  shares: number;
  relatedPlace: {
    id: string;
    name: string;
    distance: number;
  };
}

const MOCK_SHORTS: ShortsVideo[] = [
  {
    id: 'short-1',
    youtubeId: 'dQw4w9WgXcQ',
    title: '키즈카페 현장 영상',
    author: '엄마A',
    likes: 1234,
    comments: 89,
    shares: 56,
    relatedPlace: {
      id: 'place-1',
      name: '키즈카페 뽀로로파크 강남점',
      distance: 1200,
    },
  },
  {
    id: 'short-2',
    youtubeId: 'dQw4w9WgXcQ',
    title: '어린이대공원 놀이터',
    author: '엄마B',
    likes: 2345,
    comments: 134,
    shares: 78,
    relatedPlace: {
      id: 'place-2',
      name: '어린이대공원',
      distance: 3500,
    },
  },
  {
    id: 'short-3',
    youtubeId: 'dQw4w9WgXcQ',
    title: '박물관 체험 후기',
    author: '엄마C',
    likes: 890,
    comments: 45,
    shares: 23,
    relatedPlace: {
      id: 'place-3',
      name: '국립중앙박물관 어린이박물관',
      distance: 2100,
    },
  },
];

export default function ShortsFeedScreen() {
  const navigation = useNavigation<ShortsScreenNavigationProp>();
  const [currentIndex, setCurrentIndex] = useState(0);
  const flatListRef = useRef<FlatList>(null);

  const handleViewableItemsChanged = useCallback(
    ({ viewableItems }: { viewableItems: ViewToken[] }) => {
      if (viewableItems.length > 0) {
        setCurrentIndex(viewableItems[0].index || 0);
      }
    },
    []
  );

  const viewabilityConfig = useRef({
    itemVisiblePercentThreshold: 50,
  }).current;

  const renderItem = useCallback(
    ({ item, index }: { item: ShortsVideo; index: number }) => (
      <ShortsVideoItem
        video={item}
        isActive={index === currentIndex}
        navigation={navigation}
      />
    ),
    [currentIndex, navigation]
  );

  return (
    <SafeAreaView style={styles.container}>
      <FlatList
        ref={flatListRef}
        data={MOCK_SHORTS}
        renderItem={renderItem}
        keyExtractor={(item) => item.id}
        pagingEnabled
        snapToInterval={SCREEN_HEIGHT}
        snapToAlignment="start"
        decelerationRate="fast"
        showsVerticalScrollIndicator={false}
        onViewableItemsChanged={handleViewableItemsChanged}
        viewabilityConfig={viewabilityConfig}
        removeClippedSubviews
        windowSize={3}
        maxToRenderPerBatch={2}
        initialNumToRender={1}
      />
    </SafeAreaView>
  );
}

// ============================================
// Shorts Video Item
// ============================================

interface ShortsVideoItemProps {
  video: ShortsVideo;
  isActive: boolean;
  navigation: ShortsScreenNavigationProp;
}

function ShortsVideoItem({ video, isActive, navigation }: ShortsVideoItemProps) {
  const [liked, setLiked] = useState(false);
  const [saved, setSaved] = useState(false);
  const [showLikeAnimation, setShowLikeAnimation] = useState(false);
  const lastTap = useRef<number>(0);
  const likeScale = useRef(new Animated.Value(0)).current;

  const handleLike = () => {
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium);
    setLiked(!liked);
  };

  const handleDoubleTap = () => {
    const now = Date.now();
    const DOUBLE_TAP_DELAY = 300;

    if (now - lastTap.current < DOUBLE_TAP_DELAY) {
      // Double tap detected
      if (!liked) {
        setLiked(true);
        Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Heavy);

        // Show like animation
        setShowLikeAnimation(true);
        likeScale.setValue(0);
        Animated.sequence([
          Animated.spring(likeScale, {
            toValue: 1,
            friction: 3,
            useNativeDriver: true,
          }),
          Animated.timing(likeScale, {
            toValue: 0,
            delay: 500,
            duration: 200,
            useNativeDriver: true,
          }),
        ]).start(() => setShowLikeAnimation(false));
      }
    }
    lastTap.current = now;
  };

  const handleComment = () => {
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
    // Comments functionality - future enhancement
  };

  const handleShare = async () => {
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
    const Sharing = require('expo-sharing');
    if (await Sharing.isAvailableAsync()) {
      await Sharing.shareAsync('', {
        mimeType: 'text/plain',
        dialogTitle: video.title,
      });
    }
  };

  const handleSave = () => {
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium);
    setSaved(!saved);
  };

  const handleVisitPlace = () => {
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium);
    // Navigate to Map tab with the place
    navigation.navigate('Map');
  };

  return (
    <View style={styles.videoContainer}>
      {/* Video Player */}
      <VideoPlayer
        videoId={video.youtubeId}
        title={video.title}
        author={video.author}
        autoPlay={isActive}
      />

      {/* Double-tap detector */}
      <TouchableWithoutFeedback onPress={handleDoubleTap}>
        <View style={StyleSheet.absoluteFill} />
      </TouchableWithoutFeedback>

      {/* Like Animation */}
      {showLikeAnimation && (
        <Animated.View
          style={[
            styles.likeAnimationContainer,
            {
              transform: [{ scale: likeScale }],
              opacity: likeScale,
            },
          ]}
        >
          <Ionicons name="heart" size={120} color="#FF3B30" />
        </Animated.View>
      )}

      {/* Overlay UI */}
      <View style={styles.overlay}>
        {/* Right Actions Column */}
        <View style={styles.actionsColumn}>
          {/* Like */}
          <ActionButton
            icon={liked ? 'heart' : 'heart-outline'}
            label={formatCount(video.likes + (liked ? 1 : 0))}
            color={liked ? '#FF3B30' : '#FFFFFF'}
            onPress={handleLike}
          />

          {/* Comment */}
          <ActionButton
            icon="chatbubble-outline"
            label={formatCount(video.comments)}
            onPress={handleComment}
          />

          {/* Share */}
          <ActionButton
            icon="share-outline"
            label={formatCount(video.shares)}
            onPress={handleShare}
          />

          {/* Save */}
          <ActionButton
            icon={saved ? 'bookmark' : 'bookmark-outline'}
            label="Save"
            color={saved ? '#FF9500' : '#FFFFFF'}
            onPress={handleSave}
          />
        </View>

        {/* Bottom Info */}
        <View style={styles.bottomInfo}>
          {/* Author */}
          <View style={styles.authorRow}>
            <View style={styles.authorAvatar}>
              <Text style={styles.authorInitial}>
                {video.author.charAt(0)}
              </Text>
            </View>
            <Text style={styles.authorName}>{video.author}</Text>
          </View>

          {/* Caption */}
          <Text style={styles.caption} numberOfLines={2}>
            {video.title}
          </Text>

          {/* Related Place CTA */}
          <TouchableOpacity
            style={styles.placeButton}
            onPress={handleVisitPlace}
            activeOpacity={0.9}
          >
            <View style={styles.placeButtonContent}>
              <View>
                <Text style={styles.placeButtonTitle}>
                  {video.relatedPlace.name}
                </Text>
                <Text style={styles.placeButtonDistance}>
                  {video.relatedPlace.distance < 1000
                    ? `${Math.round(video.relatedPlace.distance)}m away`
                    : `${(video.relatedPlace.distance / 1000).toFixed(1)}km away`}
                </Text>
              </View>
              <Ionicons name="chevron-forward" size={20} color="#007AFF" />
            </View>
          </TouchableOpacity>
        </View>
      </View>
    </View>
  );
}

// ============================================
// Action Button Component
// ============================================

interface ActionButtonProps {
  icon: keyof typeof Ionicons.glyphMap;
  label: string;
  color?: string;
  onPress: () => void;
}

function ActionButton({
  icon,
  label,
  color = '#FFFFFF',
  onPress,
}: ActionButtonProps) {
  return (
    <TouchableOpacity
      style={styles.actionButton}
      onPress={onPress}
      activeOpacity={0.8}
    >
      <Ionicons name={icon} size={32} color={color} />
      <Text style={styles.actionLabel}>{label}</Text>
    </TouchableOpacity>
  );
}

// ============================================
// Utilities
// ============================================

function formatCount(count: number): string {
  if (count >= 1000000) {
    return `${(count / 1000000).toFixed(1)}M`;
  }
  if (count >= 1000) {
    return `${(count / 1000).toFixed(1)}K`;
  }
  return count.toString();
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#000000',
  },
  videoContainer: {
    height: SCREEN_HEIGHT,
    width: SCREEN_WIDTH,
    position: 'relative',
  },
  likeAnimationContainer: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    justifyContent: 'center',
    alignItems: 'center',
    pointerEvents: 'none',
  },
  overlay: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    justifyContent: 'flex-end',
    pointerEvents: 'box-none',
  },
  actionsColumn: {
    position: 'absolute',
    right: 12,
    bottom: 100,
    gap: 24,
    alignItems: 'center',
  },
  actionButton: {
    alignItems: 'center',
    gap: 4,
  },
  actionLabel: {
    fontSize: 12,
    fontWeight: '600',
    color: '#FFFFFF',
    textShadowColor: 'rgba(0, 0, 0, 0.75)',
    textShadowOffset: { width: 0, height: 1 },
    textShadowRadius: 3,
  },
  bottomInfo: {
    paddingHorizontal: 16,
    paddingBottom: 100, // Space for tab bar
    gap: 12,
  },
  authorRow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 10,
  },
  authorAvatar: {
    width: 36,
    height: 36,
    borderRadius: 18,
    backgroundColor: '#007AFF',
    justifyContent: 'center',
    alignItems: 'center',
  },
  authorInitial: {
    fontSize: 16,
    fontWeight: '600',
    color: '#FFFFFF',
  },
  authorName: {
    fontSize: 15,
    fontWeight: '600',
    color: '#FFFFFF',
    textShadowColor: 'rgba(0, 0, 0, 0.75)',
    textShadowOffset: { width: 0, height: 1 },
    textShadowRadius: 3,
  },
  caption: {
    fontSize: 15,
    fontWeight: '400',
    color: '#FFFFFF',
    textShadowColor: 'rgba(0, 0, 0, 0.75)',
    textShadowOffset: { width: 0, height: 1 },
    textShadowRadius: 3,
  },
  placeButton: {
    backgroundColor: 'rgba(255, 255, 255, 0.95)',
    borderRadius: 12,
    padding: 14,
  },
  placeButtonContent: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  placeButtonTitle: {
    fontSize: 16,
    fontWeight: '600',
    color: '#1C1C1E',
    marginBottom: 2,
  },
  placeButtonDistance: {
    fontSize: 14,
    fontWeight: '400',
    color: '#8E8E93',
  },
});
