generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PostType {
  QUESTION
  REVIEW
  INFO
  GROUPBUY_REQUEST
}

enum AlertFrequency {
  INSTANT
  DAILY_DIGEST
}

enum SubscriptionTier {
  FREE
  BASIC
  PRO
  FAMILY
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
}

enum AiJobStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
}

enum PartnerPlatform {
  NAVER_CAFE
  KAKAO_OPENCHAT
  BAND
  OTHER
}

enum PartnerStatus {
  ACTIVE
  PAUSED
  TERMINATED
}

enum WidgetType {
  TO_ALERT
  ADMISSION_SCORE
  DEALS
  TRENDING
  BOT
}

enum ReferralEventType {
  INSTALL
  SIGNUP
  SUBSCRIBE
  DEAL_PURCHASE
}

enum PayoutStatus {
  PENDING
  APPROVED
  PAID
  FAILED
}

model User {
  id          String   @id @default(cuid())
  email       String?  @unique
  handle      String?  @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isAdmin     Boolean  @default(false)

  childProfiles  ChildProfile[]
  memberships    Membership[]
  posts          Post[]
  comments       Comment[]
  bookmarks      Bookmark[]
  alertRules     AlertRule[]
  notifications  Notification[]
  subscription   Subscription?
  aiJobs         AiJob[]
  aiUsage        AiUsage[]
  dealRequests   DealRequest[]
  referralAttributions ReferralAttribution[]
  referralEvents       ReferralEvent[]
}

model ChildProfile {
  id        String   @id @default(cuid())
  userId    String
  birthYear Int
  stage     String? // e.g., 0-2, 3-5, 초저
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Neighborhood {
  id        String   @id @default(cuid())
  city      String
  district  String
  name      String
  createdAt DateTime @default(now())

  memberships Membership[]
  posts       Post[]
  places      Place[]
  alertRules  AlertRule[]

  @@index([city, district])
  @@unique([city, district, name])
}

model Membership {
  id             String   @id @default(cuid())
  userId         String
  neighborhoodId String
  createdAt      DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  neighborhood Neighborhood @relation(fields: [neighborhoodId], references: [id], onDelete: Cascade)

  @@unique([userId, neighborhoodId])
  @@index([neighborhoodId])
}

model Place {
  id             String   @id @default(cuid())
  neighborhoodId String
  name           String
  category       String // 키즈카페/소아과/식당/체험...
  address        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  neighborhood Neighborhood @relation(fields: [neighborhoodId], references: [id], onDelete: Cascade)
  reviews      PlaceReview[]

  @@index([neighborhoodId, category])
  @@unique([neighborhoodId, name])
}

model Post {
  id             String   @id @default(cuid())
  userId         String
  neighborhoodId String?
  cohortYear     Int?
  type           PostType
  title          String
  body           String
  placeId        String? // 후기 포스트가 특정 place를 참조할 수 있음
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  neighborhood Neighborhood? @relation(fields: [neighborhoodId], references: [id], onDelete: SetNull)
  place        Place?        @relation(fields: [placeId], references: [id], onDelete: SetNull)
  comments     Comment[]
  reactions    Reaction[]
  alertEvents  AlertEvent[]

  @@index([neighborhoodId, createdAt])
  @@index([cohortYear, createdAt])
  @@index([type, createdAt])
}

model Comment {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  body      String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt])
}

model Reaction {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  type      String // like, useful, etc.
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId, type])
}

model PlaceReview {
  id        String   @id @default(cuid())
  placeId   String
  userId    String
  summary   String
  tags      String[]
  content   String?
  createdAt DateTime @default(now())

  place Place @relation(fields: [placeId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([placeId, createdAt])
}

model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  postId    String?
  placeId   String?
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  post  Post? @relation(fields: [postId], references: [id], onDelete: Cascade)
  place Place? @relation(fields: [placeId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model AlertRule {
  id             String   @id @default(cuid())
  userId         String
  neighborhoodId String?
  cohortYear     Int?
  keywords       String[]
  categories     String[] // 예: ["모집", "추가모집", "TO"]
  frequency      AlertFrequency @default(INSTANT)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  neighborhood Neighborhood? @relation(fields: [neighborhoodId], references: [id], onDelete: SetNull)

  @@index([userId, isActive])
  @@index([neighborhoodId])
  @@index([cohortYear])
}

model AlertEvent {
  id        String   @id @default(cuid())
  postId    String
  kind      String // "post.created" 등
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([createdAt])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  body      String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model SubscriptionPlan {
  id            String   @id @default(cuid())
  tier          SubscriptionTier @unique
  priceMonthly  Int
  alertLimit    Int
  aiMonthlyLimit Int
  createdAt     DateTime @default(now())
}

model Subscription {
  id               String   @id @default(cuid())
  userId           String   @unique
  tier             SubscriptionTier
  status           SubscriptionStatus
  currentPeriodEnd DateTime?
  provider         String? // stripe
  providerSubId    String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tier, status])
}

model AiJob {
  id        String    @id @default(cuid())
  userId    String
  type      String // inquiry_message, compare_table...
  input     Json
  status    AiJobStatus @default(QUEUED)
  output    Json?
  error     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([status])
}

model AiUsage {
  id     String  @id @default(cuid())
  userId String
  month  String  // YYYY-MM
  count  Int     @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month])
}

model Deal {
  id             String   @id @default(cuid())
  title          String
  description    String?
  partner        String?
  commissionRate Float    @default(0.1)
  startAt        DateTime?
  endAt          DateTime?
  createdAt      DateTime @default(now())
}

model DealRequest {
  id          String   @id @default(cuid())
  userId      String
  productName String
  url         String?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
}

model PartnerOrg {
  id           String   @id @default(cuid())
  name         String   @unique
  orgType      String?  // momcafe, media, school, etc
  contactName  String?
  contactEmail String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  cafes   PartnerCafe[]
  apiKeys PartnerApiKey[]

  @@index([name])
}

model PartnerApiKey {
  id        String   @id @default(cuid())
  orgId     String
  label     String?
  keyHash   String   @unique
  createdAt DateTime @default(now())
  revokedAt DateTime?

  org PartnerOrg @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, revokedAt])
}

model PartnerCafe {
  id             String          @id @default(cuid())
  orgId          String
  platform       PartnerPlatform @default(NAVER_CAFE)
  platformCafeId String?
  name           String
  url            String?
  region         String?
  status         PartnerStatus   @default(ACTIVE)

  // revenue share (default values can be overridden per cafe)
  shareRateSubscription Float @default(0.2)
  shareRateCommerce     Float @default(0.1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org          PartnerOrg       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  widgets      PartnerWidget[]
  referralLinks ReferralLink[]
  externalPosts ExternalPost[]
  payoutLedgers PayoutLedger[]

  @@unique([platform, platformCafeId])
  @@index([orgId, status])
  @@index([platform, platformCafeId])
}

model PartnerWidget {
  id        String     @id @default(cuid())
  cafeId    String
  type      WidgetType
  widgetKey String     @unique
  config    Json?
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())

  cafe PartnerCafe @relation(fields: [cafeId], references: [id], onDelete: Cascade)

  @@index([cafeId, type, isActive])
}

model ReferralLink {
  id          String   @id @default(cuid())
  cafeId      String
  code        String   @unique
  channel     String?  // banner, post, admin_menu, etc
  landingPath String   @default("/install")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  cafe   PartnerCafe @relation(fields: [cafeId], references: [id], onDelete: Cascade)
  events ReferralEvent[]
  attributions ReferralAttribution[]

  @@index([cafeId, isActive])
}

model ReferralAttribution {
  id          String   @id @default(cuid())
  code        String
  userId      String?
  anonymousId String?
  firstTouchAt DateTime @default(now())
  lastTouchAt  DateTime @updatedAt
  expiresAt    DateTime

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  link ReferralLink @relation(fields: [code], references: [code], onDelete: Cascade)

  @@index([userId])
  @@index([anonymousId])
  @@index([expiresAt])
}

model ReferralEvent {
  id          String           @id @default(cuid())
  code        String
  userId      String?
  anonymousId String?
  type        ReferralEventType
  amount      Int?             // in KRW
  currency    String?          // KRW
  metadata    Json?
  createdAt   DateTime         @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  link ReferralLink @relation(fields: [code], references: [code], onDelete: Cascade)

  @@index([createdAt])
  @@index([code, type, createdAt])
}

model PayoutLedger {
  id                 String       @id @default(cuid())
  cafeId             String
  period             String       // YYYY-MM
  grossSubscription  Int          @default(0)
  grossCommerce      Int          @default(0)
  shareSubscription  Int          @default(0)
  shareCommerce      Int          @default(0)
  status             PayoutStatus @default(PENDING)
  memo               String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  cafe PartnerCafe @relation(fields: [cafeId], references: [id], onDelete: Cascade)

  @@unique([cafeId, period])
  @@index([period, status])
}

model ExternalPost {
  id          String   @id @default(cuid())
  cafeId      String
  externalId  String
  title       String
  body        String
  url         String?
  authorHash  String?
  postedAt    DateTime?
  fetchedAt   DateTime @default(now())
  raw         Json?
  toMention   Boolean  @default(false)
  toConfidence Float   @default(0.0)

  cafe PartnerCafe @relation(fields: [cafeId], references: [id], onDelete: Cascade)
  toDetections ToDetection[]

  @@unique([cafeId, externalId])
  @@index([cafeId, fetchedAt])
  @@index([toMention, toConfidence])
}

model ToDetection {
  id            String   @id @default(cuid())
  externalPostId String
  facilityName  String?
  ageClass      String?
  waitingPosition Int?
  estimatedSlots Int?
  confidence    Float    @default(0.6)
  extracted     Json?
  createdAt     DateTime @default(now())

  externalPost ExternalPost @relation(fields: [externalPostId], references: [id], onDelete: Cascade)

  @@index([createdAt])
}