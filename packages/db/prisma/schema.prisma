generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PostType {
  QUESTION
  REVIEW
  INFO
  GROUPBUY_REQUEST
}

enum AlertFrequency {
  INSTANT
  DAILY_DIGEST
}

enum SubscriptionTier {
  FREE
  BASIC
  PRO
  FAMILY
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
}

enum AiJobStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
}

model User {
  id          String   @id @default(cuid())
  email       String?  @unique
  handle      String?  @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  childProfiles  ChildProfile[]
  memberships    Membership[]
  posts          Post[]
  comments       Comment[]
  bookmarks      Bookmark[]
  alertRules     AlertRule[]
  notifications  Notification[]
  subscription   Subscription?
  aiJobs         AiJob[]
  aiUsage        AiUsage[]
  dealRequests   DealRequest[]
}

model ChildProfile {
  id        String   @id @default(cuid())
  userId    String
  birthYear Int
  stage     String? // e.g., 0-2, 3-5, 초저
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Neighborhood {
  id        String   @id @default(cuid())
  city      String
  district  String
  name      String
  createdAt DateTime @default(now())

  memberships Membership[]
  posts       Post[]
  places      Place[]
  alertRules  AlertRule[]

  @@index([city, district])
  @@unique([city, district, name])
}

model Membership {
  id             String   @id @default(cuid())
  userId         String
  neighborhoodId String
  createdAt      DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  neighborhood Neighborhood @relation(fields: [neighborhoodId], references: [id], onDelete: Cascade)

  @@unique([userId, neighborhoodId])
  @@index([neighborhoodId])
}

model Place {
  id             String   @id @default(cuid())
  neighborhoodId String
  name           String
  category       String // 키즈카페/소아과/식당/체험...
  address        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  neighborhood Neighborhood @relation(fields: [neighborhoodId], references: [id], onDelete: Cascade)
  reviews      PlaceReview[]

  @@index([neighborhoodId, category])
  @@unique([neighborhoodId, name])
}

model Post {
  id             String   @id @default(cuid())
  userId         String
  neighborhoodId String?
  cohortYear     Int?
  type           PostType
  title          String
  body           String
  placeId        String? // 후기 포스트가 특정 place를 참조할 수 있음
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  neighborhood Neighborhood? @relation(fields: [neighborhoodId], references: [id], onDelete: SetNull)
  place        Place?        @relation(fields: [placeId], references: [id], onDelete: SetNull)
  comments     Comment[]
  reactions    Reaction[]
  alertEvents  AlertEvent[]

  @@index([neighborhoodId, createdAt])
  @@index([cohortYear, createdAt])
  @@index([type, createdAt])
}

model Comment {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  body      String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt])
}

model Reaction {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  type      String // like, useful, etc.
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId, type])
}

model PlaceReview {
  id        String   @id @default(cuid())
  placeId   String
  userId    String
  summary   String
  tags      String[]
  content   String?
  createdAt DateTime @default(now())

  place Place @relation(fields: [placeId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([placeId, createdAt])
}

model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  postId    String?
  placeId   String?
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  post  Post? @relation(fields: [postId], references: [id], onDelete: Cascade)
  place Place? @relation(fields: [placeId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model AlertRule {
  id             String   @id @default(cuid())
  userId         String
  neighborhoodId String?
  cohortYear     Int?
  keywords       String[]
  categories     String[] // 예: ["모집", "추가모집", "TO"]
  frequency      AlertFrequency @default(INSTANT)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  neighborhood Neighborhood? @relation(fields: [neighborhoodId], references: [id], onDelete: SetNull)

  @@index([userId, isActive])
  @@index([neighborhoodId])
  @@index([cohortYear])
}

model AlertEvent {
  id        String   @id @default(cuid())
  postId    String
  kind      String // "post.created" 등
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([createdAt])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  body      String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model SubscriptionPlan {
  id            String   @id @default(cuid())
  tier          SubscriptionTier @unique
  priceMonthly  Int
  alertLimit    Int
  aiMonthlyLimit Int
  createdAt     DateTime @default(now())
}

model Subscription {
  id               String   @id @default(cuid())
  userId           String   @unique
  tier             SubscriptionTier
  status           SubscriptionStatus
  currentPeriodEnd DateTime?
  provider         String? // stripe
  providerSubId    String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tier, status])
}

model AiJob {
  id        String    @id @default(cuid())
  userId    String
  type      String // inquiry_message, compare_table...
  input     Json
  status    AiJobStatus @default(QUEUED)
  output    Json?
  error     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([status])
}

model AiUsage {
  id     String  @id @default(cuid())
  userId String
  month  String  // YYYY-MM
  count  Int     @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month])
}

model Deal {
  id             String   @id @default(cuid())
  title          String
  description    String?
  partner        String?
  commissionRate Float    @default(0.1)
  startAt        DateTime?
  endAt          DateTime?
  createdAt      DateTime @default(now())
}

model DealRequest {
  id          String   @id @default(cuid())
  userId      String
  productName String
  url         String?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
}
